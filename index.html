<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç”µå½±å°è¯æ£€ç´¢ Â· Demo</title>
<style>
  :root{ --bg:#0f1115; --panel:#161a24; --ring:#2a3245; --muted:#9aa4b2; --text:#e8ecf1; --accent:#6aa0ff; --chip:#23293a; }
  *{box-sizing:border-box}
  body{margin:0; background:radial-gradient(1000px 500px at 25% -5%, #1a2132 0,#0f1115 60%) fixed; color:var(--text);
       font:15.5px/1.6 system-ui,-apple-system,Segoe UI,Roboto,"PingFang SC","Helvetica Neue",Arial }
  .wrap{max-width:1200px; margin:0 auto; padding:22px 16px 48px;}
  header{display:flex; align-items:center; gap:10px; margin-bottom:10px}
  header h1{font-size:22px; margin:0 6px 0 0}
  .pill{background:var(--chip); color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px}
  .bar{position:sticky; top:0; z-index:5; margin:10px 0 18px; background:linear-gradient(180deg, rgba(15,17,21,.95), rgba(15,17,21,.65) 70%, transparent);
       backdrop-filter: blur(6px); padding-top:6px;}
  .bar .inner{display:flex; align-items:center; gap:10px; background:var(--panel); border:1px solid var(--ring); border-radius:12px; padding:12px 14px;
              box-shadow:0 6px 18px rgba(0,0,0,.25), inset 0 0 0 1px rgba(255,255,255,.02);}
  input[type="search"]{flex:1; background:transparent; border:0; outline:none; font-size:16px; color:var(--text)}
  input::placeholder{color:#8b94a3}
  .count{font-variant-numeric: tabular-nums}
  main{display:grid; grid-template-columns: minmax(320px, 520px) 1fr; gap:16px}
  .panel{background:var(--panel); border:1px solid var(--ring); border-radius:14px; padding:12px; min-height:280px;
         box-shadow:0 10px 26px rgba(0,0,0,.25)}
  .results{display:flex; flex-direction:column; gap:8px; max-height:70vh; overflow:auto}
  .item{display:block; padding:10px 12px; border:1px solid transparent; border-radius:10px; text-decoration:none; color:inherit}
  .item:hover{background:#1b2130; border-color:#2b364b}
  .item h3{margin:0 0 4px; font-size:15px}
  .meta{display:flex; flex-wrap:wrap; gap:6px; margin-bottom:4px}
  .chip{background:var(--chip); color:var(--muted); padding:2px 8px; border-radius:999px; font-size:12px}
  .snippet{color:#c8d0dc; font-size:13px}
  mark{background:transparent; color:inherit; padding:0 0 2px; border-bottom:2px solid var(--accent)}
  .scene-head{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px}
  .scene-title{font-weight:700; margin:0; font-size:16px}
  .nav-btns{display:flex; gap:8px}
  button{background:#20273a; color:#e8ecf1; border:1px solid #2a3245; border-radius:8px; padding:6px 10px; cursor:pointer}
  button:disabled{opacity:.5; cursor:not-allowed}
  .lines{display:flex; flex-direction:column; gap:6px; max-height:62vh; overflow:auto; padding-right:4px}
  .line{padding:8px 10px; border:1px solid #2a3245; border-radius:10px}
  .who{font-weight:700}
  .ts{color:#9fb0c9; font-variant-numeric: tabular-nums; margin-left:6px}
  .empty{padding:18px; border:1px dashed var(--ring); border-radius:12px; color:#9aa4b2; text-align:center}
  .footer{margin-top:10px; color:#9aa4b2; font-size:12px}
  .row{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
  .file{display:inline-block}
  .tips{color:#9aa4b2; font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ğŸï¸ ç”µå½±å°è¯æ£€ç´¢</h1>
    <span class="pill">å…¨åº“æœç´¢å°è¯ï¼ˆè‹±æ–‡åå¥ï¼‰</span>
    <span class="pill">URL ç›´è¾¾</span>
    <span class="pill">å¯å¯¼å…¥ JSON</span>
  </header>

  <div class="bar">
    <div class="inner">
      <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79L20 21.49L21.49 20zM9.5 14C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5S14 7.01 14 9.5S11.99 14 9.5 14"></path></svg>
      <input id="q" type="search" placeholder="è¾“å…¥å…³é”®è¯ï¼šbox of chocolates / hope / king of the world â€¦">
      <span class="pill"><span id="cnt" class="count">0</span> æ¡å‘½ä¸­</span>
      <label class="file pill" style="cursor:pointer">
        <input id="file" type="file" accept="application/json" hidden>
        å¯¼å…¥JSON
      </label>
    </div>
    <div class="row tips" style="margin:6px 4px 0 4px">
      æ”¯æŒå¤šå…³é”®è¯ <code>AND</code>ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰ï¼›å­—æ®µï¼šå°è¯æ–‡æœ¬ã€è§’è‰²ã€åœºæ™¯åã€ç”µå½±åã€æ—¶é—´æˆ³ï¼ˆå¦‚ <code>01:23:45</code>ï¼‰ã€‚
    </div>
  </div>

  <main>
    <!-- å·¦ä¾§ï¼šæ£€ç´¢ç»“æœ -->
    <section class="panel">
      <div id="results" class="results" role="list"></div>
      <div id="nores" class="empty" style="display:none">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…ç»“æœã€‚</div>
      <div class="footer">å°è´´å£«ï¼šå¯é€šè¿‡ URL å‚æ•°å…±äº«çŠ¶æ€ï¼Œå¦‚ <code>?q=hope&movie=shawshank&scene=library</code></div>
    </section>

    <!-- å³ä¾§ï¼šåœºæ™¯æŸ¥çœ‹ -->
    <section class="panel">
      <div class="scene-head">
        <h2 id="sceneTitle" class="scene-title">é€‰æ‹©å·¦ä¾§ç»“æœæ¥æŸ¥çœ‹å…·ä½“åœºæ™¯</h2>
        <div class="nav-btns">
          <button id="prevBtn" disabled>ä¸Šä¸€å¹•</button>
          <button id="nextBtn" disabled>ä¸‹ä¸€å¹•</button>
        </div>
      </div>
      <div id="crumbs" class="meta" style="margin-bottom:8px"></div>
      <div id="lines" class="lines"></div>
    </section>
  </main>
</div>

<script>
/* ===================== 1) ä½ çš„å†…ç½®è‹±æ–‡å°è¯åº“ï¼ˆç»å…¸çŸ­å¥ï¼Œéå…¨æ–‡ï¼‰ ===================== */
let DB = {
  movies: [
    {
      id: "forrest_gump",
      title: "Forrest Gump",
      year: 1994,
      scenes: [
        {
          id: "bench",
          title: "Bus Stop Bench",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Forrest", text: "Life is like a box of chocolates." },
            { t: "", who: "Forrest", text: "You never know what you're gonna get." }
          ]
        },
        {
          id: "run",
          title: "Run, Forrest, Run",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Jenny", text: "Run, Forrest, run!" },
            { t: "", who: "Forrest", text: "I just kept on running." }
          ]
        },
        {
          id: "love",
          title: "About Love",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Forrest", text: "I'm not a smart man, but I know what love is." }
          ]
        }
      ]
    },
    {
      id: "truman_show",
      title: "The Truman Show",
      year: 1998,
      scenes: [
        {
          id: "greeting",
          title: "Morning Greeting",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Truman", text: "Good morning!" },
            { t: "", who: "Truman", text: "And in case I don't see ya, good afternoon, good evening, and good night!" }
          ]
        },
        {
          id: "reality",
          title: "On Reality",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Christof", text: "We accept the reality of the world with which we're presented." }
          ]
        },
        {
          id: "spontaneous",
          title: "Spontaneous",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Truman", text: "Somebody help me! I'm being spontaneous!" }
          ]
        }
      ]
    },
    {
      id: "shawshank",
      title: "The Shawshank Redemption",
      year: 1994,
      scenes: [
        {
          id: "library",
          title: "Library and Hope",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Andy", text: "Hope is a good thing, maybe the best of things." },
            { t: "", who: "Red",  text: "Get busy living, or get busy dying." }
          ]
        },
        {
          id: "choice",
          title: "Simple Choice",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Red", text: "I guess it comes down to a simple choice, really." }
          ]
        }
      ]
    },
    {
      id: "titanic",
      title: "Titanic",
      year: 1997,
      scenes: [
        {
          id: "prow",
          title: "King of the World",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Jack", text: "I'm the king of the world!" }
          ]
        },
        {
          id: "drawing",
          title: "French Girls",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Rose", text: "Draw me like one of your French girls." }
          ]
        },
        {
          id: "promise",
          title: "You Jump, I Jump",
          start: "",
          end: "",
          lines: [
            { t: "", who: "Jack", text: "You jump, I jump." },
            { t: "", who: "Rose", text: "I'll never let go." }
          ]
        }
      ]
    }
  ]
};

/* ===================== 2) å·¥å…·å‡½æ•°ï¼ˆè½¬ä¹‰/é«˜äº®/é˜²æŠ–/URLï¼‰ ===================== */
const esc = s => (s??"").toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
const rex = s => s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
function highlight(text, q){
  if(!q) return esc(text);
  const words = q.trim().split(/\s+/).filter(Boolean).map(rex);
  if(!words.length) return esc(text);
  return esc(text).replace(new RegExp('('+words.join('|')+')','gi'),'<mark>$1</mark>');
}
function debounce(fn, d=160){ let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a),d)} }
function getParam(k){ const u=new URL(location.href); return u.searchParams.get(k) }
function setParams(obj){
  const u = new URL(location.href);
  Object.entries(obj).forEach(([k,v])=>{
    if(v==null || v==="") u.searchParams.delete(k);
    else u.searchParams.set(k, v);
  });
  history.replaceState(null,"",u.toString());
}

/* ===================== 3) æœç´¢ ===================== */
function searchLines(rawQ){
  const q = (rawQ||"").trim().toLowerCase();
  const words = q.split(/\s+/).filter(Boolean);
  const all = [];
  for(const mv of DB.movies){
    for(const sc of (mv.scenes||[])){
      for(let i=0;i<(sc.lines||[]).length;i++){
        const ln = sc.lines[i];
        const hay = [ ln.text, ln.who, ln.t, sc.title, mv.title ].join(" ").toLowerCase();
        const ok = words.length ? words.every(w=>hay.includes(w)) : true;
        if(ok){
          const score = words.reduce((s,w)=> s + (hay.includes(w)?1:0), 0);
          all.push({ movieId: mv.id, movieTitle: mv.title, sceneId: sc.id, sceneTitle: sc.title, pos: i, line: ln, score });
        }
      }
    }
  }
  all.sort((a,b)=> b.score - a.score || a.movieTitle.localeCompare(b.movieTitle) || a.sceneTitle.localeCompare(b.sceneTitle) || (a.line.t||"").localeCompare(b.line.t||""));
  return all;
}

/* ===================== 4) æ¸²æŸ“ ===================== */
const $q = document.getElementById('q');
const $cnt = document.getElementById('cnt');
const $results = document.getElementById('results');
const $nores = document.getElementById('nores');
const $lines = document.getElementById('lines');
const $sceneTitle = document.getElementById('sceneTitle');
const $crumbs = document.getElementById('crumbs');
const $prev = document.getElementById('prevBtn');
const $next = document.getElementById('nextBtn');

function renderResults(list, q){
  $results.innerHTML = "";
  $cnt.textContent = list.length;
  $nores.style.display = list.length ? "none":"block";

  const frag = document.createDocumentFragment();
  for(const r of list){
    const a = document.createElement('a');
    a.href = "#";
    a.className = "item";
    a.setAttribute("role","listitem");
    a.dataset.movie = r.movieId;
    a.dataset.scene = r.sceneId;
    a.dataset.pos = r.pos;

    const h3 = document.createElement('h3');
    h3.innerHTML = `${highlight(r.movieTitle, q)} â€” ${highlight(r.sceneTitle, q)}`;

    const meta = document.createElement('div'); meta.className = "meta";
    const c1 = document.createElement('span'); c1.className = "chip"; c1.textContent = r.line.who || "Unknown";
    const c2 = document.createElement('span'); c2.className = "chip"; c2.textContent = r.line.t || "--:--:--";
    meta.append(c1,c2);

    const p = document.createElement('div'); p.className = "snippet";
    p.innerHTML = highlight(r.line.text, q);

    a.append(h3, meta, p);
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      openScene(r.movieId, r.sceneId, q);
      setParams({ q: $q.value, movie: r.movieId, scene: r.sceneId });
    });

    frag.append(a);
  }
  $results.append(frag);
}

function openScene(movieId, sceneId, q){
  const mv = DB.movies.find(m=>m.id===movieId);
  if(!mv){ return }
  const idx = mv.scenes.findIndex(s=>s.id===sceneId);
  if(idx<0){ return }
  const sc = mv.scenes[idx];

  $sceneTitle.textContent = `${mv.title} Â· ${sc.title}`;
  $crumbs.innerHTML = `
    <span class="chip">Movie</span><span class="chip">${esc(mv.title)}</span>
    <span class="chip">Scene</span><span class="chip">${esc(sc.title)}</span>
    ${sc.start? `<span class="chip">${esc(sc.start)} â€” ${esc(sc.end||"")}</span>`:""}
  `;

  $prev.disabled = idx<=0;
  $next.disabled = idx>=mv.scenes.length-1;
  $prev.onclick = ()=>{ openScene(movieId, mv.scenes[idx-1].id, q); setParams({ q: $q.value, movie: movieId, scene: mv.scenes[idx-1].id }); }
  $next.onclick = ()=>{ openScene(movieId, mv.scenes[idx+1].id, q); setParams({ q: $q.value, movie: movieId, scene: mv.scenes[idx+1].id }); }

  $lines.innerHTML = "";
  const frag = document.createDocumentFragment();
  (sc.lines||[]).forEach(ln=>{
    const div = document.createElement('div'); div.className = "line";
    const head = document.createElement('div');
    head.innerHTML = `<span class="who">${esc(ln.who||"Unknown")}</span><span class="ts">${esc(ln.t||"--:--:--")}</span>`;
    const txt = document.createElement('div');
    txt.innerHTML = highlight(ln.text||"", q);
    div.append(head, txt);
    frag.append(div);
  });
  $lines.append(frag);
}

/* ===================== 5) äº‹ä»¶ä¸åˆå§‹åŠ è½½ ===================== */
const handleInput = debounce(()=>{
  const q = $q.value;
  const list = searchLines(q);
  renderResults(list, q);
  setParams({ q, movie:getParam('movie'), scene:getParam('scene') });
}, 120);

$q.addEventListener('input', handleInput);

document.getElementById('file').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try{
    const text = await f.text();
    const json = JSON.parse(text);
    if(!json.movies || !Array.isArray(json.movies)) throw new Error("Invalid JSON: missing movies[]");
    DB = json;
    handleInput();
    const m = getParam('movie'); const s = getParam('scene');
    if(m && s) openScene(m, s, $q.value);
    alert("æ•°æ®å·²å¯¼å…¥æˆåŠŸ âœ…");
  }catch(err){
    console.error(err);
    alert("å¯¼å…¥å¤±è´¥ï¼šè¯·ç¡®è®¤ JSON ç»“æ„æ­£ç¡®ã€‚");
  }finally{
    e.target.value = "";
  }
});

window.addEventListener('DOMContentLoaded', ()=>{
  const q = getParam('q') || "";
  $q.value = q;
  renderResults(searchLines(q), q);
  const m = getParam('movie'), s = getParam('scene');
  if(m && s) openScene(m, s, q);
});
</script>
</body>
</html>
